#!/bin/bash

set -eo pipefail

CONFIGFILE="/etc/be-BOP/config.env"

case "$1" in
    purge)
        if [ -f "${CONFIGFILE}" ] && \
            grep -q "This deployment is managed by bebop-wizard" "${CONFIGFILE}"; then
            ucfr --purge bebop-wizard "${CONFIGFILE}"
        elif [ -f "${CONFIGFILE}" ] && \
            grep -q "This configuration is managed by bebop-wizard" "${CONFIGFILE}"; then
            ucfr --purge bebop-wizard "${CONFIGFILE}"
        fi

        if [ -d "$(dirname "${CONFIGFILE}")" ] && [ -z "$(ls -A "$(dirname "${CONFIGFILE}")")" ]; then
            rmdir "$(dirname "${CONFIGFILE}")"
        fi

        MONGODB_REPO_FILE="/etc/apt/sources.list.d/mongodb-org-8.0.list"
        if [ -f "${MONGODB_REPO_FILE}" ] && \
            grep -q "This file is managed by bebop-wizard" "${MONGODB_REPO_FILE}"; then
            ucfr --purge bebop-wizard "${MONGODB_REPO_FILE}"
        fi

        NODEJS_REPO_FILE="/etc/apt/sources.list.d/nodesource.list"
        if [ -f "${NODEJS_REPO_FILE}" ] && \
            grep -q "This file is managed by bebop-wizard" "${NODEJS_REPO_FILE}"; then
            ucfr --purge bebop-wizard "${NODEJS_REPO_FILE}"
        fi

        NGINX_SITE_CONF="/etc/nginx/sites-available/be-BOP.conf"
        if [ -f "${NGINX_SITE_CONF}" ] && \
            grep -q "The sites in this file are managed by bebop-wizard" "${NGINX_SITE_CONF}"; then
            ucfr --purge bebop-wizard "${NGINX_SITE_CONF}"
        fi

        MINIO_SERVICE_FILE="/etc/systemd/system/minio-bebop.service"
        if [ -f "${MINIO_SERVICE_FILE}" ] && \
            grep -q "This service is managed by bebop-wizard" "${MINIO_SERVICE_FILE}"; then
            ucfr --purge bebop-wizard "${MINIO_SERVICE_FILE}"
        fi

        PHOENIX_SERVICE_FILE="/etc/systemd/system/phoenixd-bebop.service"
        if [ -f "${PHOENIX_SERVICE_FILE}" ] && \
            grep -q "This service is managed by bebop-wizard" "${PHOENIX_SERVICE_FILE}"; then
            ucfr --purge bebop-wizard "${PHOENIX_SERVICE_FILE}"
        fi

        # Reload systemd after removing service files
        if command -v systemctl >/dev/null 2>&1; then
            systemctl daemon-reload || true
        fi

        # Remove debconf database entries
        if [ -e /usr/share/debconf/confmodule ]; then
            . /usr/share/debconf/confmodule
            db_purge || true
        fi

        echo "bebop-wizard configuration and service files removed."
        echo "Note: Service data directories (/var/lib/phoenixd, /var/lib/minio, /var/lib/be-BOP) are preserved."
        echo "Note: Installed binaries (phoenixd, minio) are preserved."
        ;;

    remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        # Do nothing for these cases
        ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

# Code autogenerated by debhelper goes here
#DEBHELPER#

exit 0
